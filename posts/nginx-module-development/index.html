<!doctype html>
<html lang="en"><head>
    <title>Development of NGINX Dynamic Modules</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="../../css/theme.css"/>
    </head><body>
        <div id="content" class="mx-auto"><header class="container mt-5 mb-5 mt-xs-1">
    <div class="row">
        <div class="col-sm-4 col-12 text-sm-right text-center p-3 pt-4">
            <img id="me" class="rounded-circle" src="../../img/me.jpeg">
        </div>
        <div class="col-sm-8 col-12 text-sm-left text-center">
            <h2 class="m-0 mb-2 mt-4">Austin Gebauer</h2>
            <p class="text-muted mb-1">Software Engineer | NGINX | Seattle, WA</p>
            <ul id="nav-links" class="list-inline mb-2">
                <li class="list-inline-item">
                    <a href="../../" class="badge badge-white">Home</a>
                </li>
                <li class="list-inline-item">
                    <a href="#" class="badge badge-white">About</a>
                </li>
                <li class="list-inline-item">
                    <a href="../../posts" class="badge badge-white">Posts</a>
                </li>
                <li class="list-inline-item">
                    <a href="#" class="badge badge-white">Categories</a>
                </li>
            </ul>
            <ul id="nav-social" class="list-inline">
                <li class="list-inline-item mr-3">
                    <i class="fab fa-github fa-1x text-muted"></i>
                </li>
                <li class="list-inline-item mr-3">
                    <i class="fab fa-linkedin-in fa-1x text-muted"></i>
                </li>
                <li class="list-inline-item mr-3">
                    <i class="fab fa-twitter fa-1x text-muted"></i>
                </li>
                <li class="list-inline-item mr-3">
                    <i class="fas fa-at fa-1x text-muted"></i>
                </li>
            </ul>
        </div>
    </div>
    <hr />
</header>

    <div class="container">
    <div>
        <h1>Development of NGINX Dynamic Modules</h1>
        

        <p>
            <a href="http://example.com/posts/nginx-module-development/">Published June 19, 2018</a>
            
                <a href="../../tags/nginx">#nginx</a>
            
                <a href="../../tags/c">#c</a>
            
                <a href="../../tags/networking">#networking</a>
            
                <a href="../../tags/software">#software</a>
            
        </p>

        <article>
            

<h1 id="nginx-dynamic-module-development-guide">NGINX Dynamic Module Development Guide</h1>

<p>The purpose of this guide is to teach basic <a href="https://www.nginx.com/">NGINX</a> dynamic module development and usage.</p>

<h1 id="table-of-contents">Table of Contents</h1>

<p>TODO: Generate TOC when complete</p>

<h2 id="development-setup">Development Setup</h2>

<p>First, we need to set up a development environment for our NGINX module.</p>

<p>Follow the steps below to set it up.</p>

<h3 id="0-install-nginx-open-source">0: Install NGINX open source</h3>

<ul>
<li><p>Follow the <a href="https://docs.nginx.com/nginx/admin-guide/installing-nginx/installing-nginx-open-source/">NGINX documentation</a>
to install NGINX open source</p>

<ul>
<li>Recommend to install on linux</li>
</ul></li>

<li><p><strong>Take note</strong> of the version of your NGINX installation</p>

<ul>
<li>We&rsquo;ll use <code>nginx/1.16.0</code> in this guide</li>
</ul></li>
</ul>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">nginx -v
&gt; nginx version: nginx/1.16.0</code></pre></td></tr></table>
</div>
</div>
<h3 id="1-download-nginx-source">1: Download NGINX source</h3>

<p>Download the NGINX package corresponding to your NGINX version at <a href="nginx.org/download">nginx.org/download</a>.</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">wget http://nginx.org/download/nginx-1.16.0.tar.gz
tar xzvf nginx-1.16.0.tar.gz</code></pre></td></tr></table>
</div>
</div>
<h3 id="2-install-development-dependencies">2: Install Development Dependencies</h3>

<p>Install development dependencies needed to compile the NGINX dynamic module</p>

<p>Example of installing NGINX development dependencies on linux with apt-get package manager.</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">apt-get install -y <span style="color:#00f">\
</span><span style="color:#00f"></span>        gnupg2 <span style="color:#00f">\
</span><span style="color:#00f"></span>        libpcre3 <span style="color:#00f">\
</span><span style="color:#00f"></span>        libpcre3-dev <span style="color:#00f">\
</span><span style="color:#00f"></span>        zlib1g <span style="color:#00f">\
</span><span style="color:#00f"></span>        zlib1g-dev <span style="color:#00f">\
</span><span style="color:#00f"></span>        libssl-dev</code></pre></td></tr></table>
</div>
</div>
<h3 id="3-create-the-nginx-module-source">3: Create the NGINX module source</h3>

<p>To begin writing an NGINX module, we&rsquo;ll create a directory and two files.</p>

<p>Create a directory for the module and change into it</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mkdir ngx_example_module
cd ngx_example_module</code></pre></td></tr></table>
</div>
</div>
<p>Create the module <code>config</code> file</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">touch config</code></pre></td></tr></table>
</div>
</div>
<p>Add the following contents to the <code>config</code> file</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ngx_addon_name=ngx_example_module

<span style="color:#000080;font-weight:bold">if</span> test -n <span style="color:#00f">&#34;</span>$ngx_module_link<span style="color:#00f">&#34;</span>; <span style="color:#000080;font-weight:bold">then</span>
    ngx_module_type=HTTP
    ngx_module_name=ngx_example_module
    ngx_module_srcs=<span style="color:#00f">&#34;</span>$ngx_addon_dir<span style="color:#00f">/ngx_example_module.c&#34;</span>
    . auto/module
<span style="color:#000080;font-weight:bold">else</span>
    HTTP_MODULES=<span style="color:#00f">&#34;</span>$HTTP_MODULES<span style="color:#00f"> ngx_example_module&#34;</span>
    NGX_ADDON_SRCS=<span style="color:#00f">&#34;</span>$NGX_ADDON_SRCS<span style="color:#00f"> </span>$ngx_addon_dir<span style="color:#00f">/ngx_example_module.c&#34;</span>
<span style="color:#000080;font-weight:bold">fi</span></code></pre></td></tr></table>
</div>
</div>
<p>Create the C source file</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">touch ngx_example_module.c</code></pre></td></tr></table>
</div>
</div>
<p>You should now have a directory structure similar to</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ngx_example_module/
├── config
└── ngx_example_module.c</code></pre></td></tr></table>
</div>
</div>
<h2 id="write-a-basic-module">Write a basic module</h2>

<p>General Concepts</p>

<p>Links to documents with more details on some type of module.</p>

<h2 id="compile-the-module">Compile the module</h2>

<p>Compile the module by first running the configure script with the &ndash;with-compat argument, which creates a standard
build environment supported by both open source NGINX and NGINX Plus. Then run make modules to build the module</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cd nginx-1.16.0
./configure --with-compat --add-dynamic-module=../ngx_example_module
make modules</code></pre></td></tr></table>
</div>
</div>
<p>Copy the module shared object library (.so file) to <code>/etc/nginx/modules</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo cp objs/ngx_example_module.so /etc/nginx/modules</code></pre></td></tr></table>
</div>
</div>
<h2 id="use-the-module">Use the Module</h2>

<p>To load the module into NGINX Plus, add the load_module directive in the top‑level (main) context of your nginx.conf
configuration file (not within the http or stream context):</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vi /etc/nginx/nginx.conf</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">load_module modules/ngx_example_module.so;</code></pre></td></tr></table>
</div>
</div>
<p>In the http context, add a location block with the hello_world directive provided by the Hello World module.
Requests to the location return the response hello world.</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vi /etc/nginx/conf.d/default.conf</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">location /hello {
     hello_world;
}</code></pre></td></tr></table>
</div>
</div>
<p>Reload your NGINX configuration and test it with a simple request:</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">nginx -s reload
curl http://localhost/hello
hello, NGINX</code></pre></td></tr></table>
</div>
</div>
        </article>
    </div>

    
        <div>
            
                Previous: <a href="../../posts/ray-tracing/">Techniques used in Recursive Ray Tracing</a>
            
        </div>
        <div>
            
        </div>
    
    </div>
<footer class="m-5">

</footer></div>
    </body>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS_HTML"></script>
</html>
